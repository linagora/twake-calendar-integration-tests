version: "3"

networks:
  emaily:
    driver: bridge

services:
  twake-calendar-side-service:
    image: tcalendar-it
    depends_on:
      opensearch:
        condition: service_healthy
      mongo:
        condition: service_started
      redis:
        condition: service_started
      rabbitmq:
        condition: service_started
      ldap:
        condition: service_started
      sabre_dav:
        condition: service_started
    networks:
      - emaily

  opensearch:
    image: opensearchproject/opensearch:2.14.0
    environment:
      - discovery.type=single-node
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - DISABLE_SECURITY_PLUGIN=true
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9200/_cluster/health" ]
      interval: 3s
      timeout: 10s
      retries: 10
    networks:
      - emaily

  redis:
    image: redis:latest
    networks:
      - emaily

  rabbitmq:
    image: rabbitmq:3.13.3-management
    networks:
      - emaily

  mongo:
    image: mongo
    networks:
      - emaily

  ldap:
    hostname: esn_ldap
    image: ldap-it
    environment:
      - LDAP_PORT_NUMBER=389
      - LDAP_ADMIN_USERNAME=admin
      - LDAP_ADMIN_PASSWORD=admin
      - LDAP_ROOT=dc=open-paas.org,dc=lng
      - BITNAMI_DEBUG=true
    networks:
      - emaily

  sabre_dav:
    hostname: esn_sabre
    image: sabre-it
    environment:
      - SABRE_ENV=dev
      - SABRE_MONGO_HOST=mongo
      - SABRE_MONGO_PORT=27017
      - ESN_MONGO_HOST=mongo
      - ESN_MONGO_PORT=27017
      - ESN_MONGO_DBNAME=esn_docker
      - MONGO_TIMEOUT=100000
      - ESN_HOST=twake-calendar-side-service
      - ESN_PORT=8080
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - AMQP_HOST=rabbitmq
      - AMQP_PORT=5672
      - AMQP_LOGIN=guest
      - AMQP_PASSWORD=guest
      - SABRE_ADMIN_LOGIN=admin
      - SABRE_ADMIN_PASSWORD=secret123
      - OPENPASS_BASIC_AUTH=YWRtaW5Ab3Blbi1wYWFzLm9yZzpzZWNyZXQ=
      - LDAP_ADMIN_DN=cn=admin,dc=open-paas.org,dc=lng
      - LDAP_ADMIN_PASSWORD=admin
      - LDAP_BASE=ou=users,dc=open-paas.org,dc=lng
      - LDAP_BASE_WITH_MAIL=ou=users,dc=open-paas.org,dc=lng
      - LDAP_SERVER=ldap://esn_ldap:389
      - LDAP_USERNAME_MODE=username
    networks:
      - emaily
